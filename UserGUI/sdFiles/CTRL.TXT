function responseTabs(){var a="",b="";if($(window).width()>800){document.getElementById("tabControl").className="container tabbable tabs-left";for(i=0;i<10;i++){a+="<br>"}for(i=0;i<3;i++){b+="<br>"}}else{document.getElementById("tabControl").className="container tabbable"}document.getElementById("tabBottomPadding").innerHTML=a;document.getElementById("tabTopPadding").innerHTML=b}window.onresize=function(){responseTabs()};responseTabs();function configDevice(d,a){var b=document.getElementById(d);switch(a){case"e":c="btn-default";t="Void";break;case"r":c="btn-info";t="Raw";break;case"w":c="btn-success";t="PWM";break;case"p":c="btn-success";t="Potentiometer";break;case"l":c="btn-warning";t="Light";break;case"t":c="btn-danger";t="Temperature";break;case"b":c="btn-primary";t="Logical";break;default:c="btn-default";t="Error";break}b.setAttribute("class","btn "+c+" dropdown-toggle");b.setAttribute("Value",t);b.innerHTML=t+' <span class="caret"></span>'}function countAddr(a,b){return a[3]-b[3]+1+(a[2]-b[2])*256+(a[1]-b[1])*256*256+(a[0]-b[0])*256*256*256}function convertIPv4FromString(a){res=a.split(".");if(res.length!=4){window.alert("Bad format in one IP Address");return null}ipOut=[];res.forEach(function(b){intNum=parseInt(b);if(intNum>255||intNum<0){window.alert("The IP address number must be below 255! (Address: $ipIn)");return null}ipOut.push(intNum)});return ipOut}function convertIPv4FromIntArray(a){return a[0]+"."+a[1]+"."+a[2]+"."+a[3]}function addOneIPv4(b){var a=convertIPv4FromString(b);a[3]++;if(a[3]==256){a[3]=0;a[2]++;if(a[2]==256){a[2]=0;a[2]++;if(a[1]==256){a[1]=0;a[0]++}}}return convertIPv4FromIntArray(a)}function validateIPv4(b){var a=b.split(".");if(a.length!=4){return false}a.forEach(function(d){d=parseInt(d);if(d>256||d<0){return false}});return true}function createCORSRequest(d,a){var b=new XMLHttpRequest();if("withCredentials" in b){b.open(d,a,true)}else{if(typeof XDomainRequest!="undefined"){b=new XDomainRequest();b.open(d,a)}else{b=null}}b.timeout=1000;b.onerror=function(f){stopAutoRead();window.alert("The IP address does not point to a valid Server\nURL:'"+a+"'\n"+f)};b.ontimeout=function(){stopAutoRead();window.alert("The IP address is unreachable.\nURL:'"+a+"'")};return b}function configDevProtected(a){if(document.domain!=document.getElementById("setNewIp").value||document.domain!=document.getElementById("ipAddress").value){window.alert("This functionality is only available for computers inside server network! (Address: '"+document.getElementById("setNewIp").value+"')");return}$.get(a).done(function(b){showConfig(b)})}function configDev(b){res=document.getElementById("ipAddress").value.split(":");port=80;if(!validateIPv4(res[0])){window.alert("IP Address not valid!");return}if(res.length==2){port=res[1]}if(document.domain!=res[0]){url="http://"+res[0]+":"+port+"/"+b}else{url="/"+b}var a=createCORSRequest("GET",url);if(!a){window.alert("CORS not supported");return}a.onload=function(){showConfig(a.responseText)};a.send()}var timer=null;var failedReads=0;function startAutoRead(){var a=document.getElementById("refreshTime").value;if(!parseInt(a)>0){window.alert("The refresh time must be numeric!");return}if(timer!=null){stopAutoRead()}failedReads=0;document.getElementById("startStopButtons").innerHTML="<button type='button' class='btn btn-default'>Start</button><button type='button' class='btn btn-danger' onclick='stopAutoRead()'>Stop</button>";timer=setInterval(function(){readValues()},a*1000);readValues()}function stopAutoRead(){clearInterval(timer);timer=null;document.getElementById("startStopButtons").innerHTML="<button type='button' class='btn btn-success' onclick='startAutoRead()'>Start</button><button type='button' class='btn btn-default'>Stop</button>"}function errorReading(){failedReads+=1;if(failedReads==3){failedReads=0;stopAutoRead();window.alert("Three failed trials to read sensors. Did you write properly the ip address?")}}function readValues(){res=document.getElementById("ipAddress2").value.split(":");if(res.length!=2){res[1]=80}if(document.domain!=res[0]){url="http://"+res[0]+":"+res[1]+"/ports"}else{url="/ports"}if(!validateIPv4(res[0])){stopAutoRead();window.alert("IP Address not valid!");return}var a=createCORSRequest("GET",url);if(!a){stopAutoRead();window.alert("CORS not supported");return}a.onload=function(){showPorts(a.responseText)};a.timeout=2000;a.onError=function(b){errorReading()};a.onTimeout=function(){errorReading()};a.send()}function setOutput(a){res=document.getElementById("ipAddress2").value.split(":");if(res.length!=2){res[1]=80}if(document.domain!=res[0]){url="http://"+res[0]+":"+res[1]+"/out/"+a}else{url="/out/"+a}var b=createCORSRequest("GET",url);b.onload=function(){showPorts(b.responseText)};b.send()}discoveryContinue=0;discoveryCount=0;discoveryIndex=0;discoveryIpCurrent=0;function nextDiscover(){new ping(discoveryIpCurrent,function(f,a,d){var b=document.getElementById("progressbar");percent=parseFloat(b.getAttribute("percent"))+1/(discoveryCount)*100;b.setAttribute("percent",percent);b.setAttribute("style","width: "+percent+"%");document.getElementById("progresslbl").innerHTML=Math.round(percent)+"% Complete";label="undefined";if(a=="success"){label='<span class="label label-success">Online Arduino</span>'}else{if(a=="error"){label='<span class="label label-warning">Other host</span>'}else{if(a=="aborted"&&document.getElementById("showOffline").checked==true){label='<span class="label label-default">Offline</span>'}else{if(document.getElementById("showOffline").checked==true){label='<span class="label label-default">Offline</span>'}}}}if(label!="undefined"){document.getElementById("devicesTable").innerHTML+="<tr><td>"+f+"</td><td>"+label+"</td></tr>"}});discoveryIpCurrent=addOneIPv4(discoveryIpCurrent);discoveryIndex=discoveryIndex+1;if(discoveryIndex<discoveryCount&&discoveryContinue==true){discoveryTimer=setTimeout(function(){nextDiscover()},200)}else{stopDiscovery()}}function startDiscovery(){discoveryIpCurrent=document.getElementById("startIP").value;startAddrInt=convertIPv4FromString(discoveryIpCurrent);stopAddrInt=convertIPv4FromString(document.getElementById("endIP").value);if(startAddrInt==null||stopAddrInt==null){return}discoveryCount=countAddr(stopAddrInt,startAddrInt);if(discoveryCount<0){window.alert("The start address must be lower than end address (count: "+discoveryCount+")");return}console.log("Starting scan... Number of ip addresses: "+discoveryCount);var a=document.getElementById("progressbar");a.setAttribute("percent",0);a.setAttribute("style","width: "+0+"%");document.getElementById("progresslbl").innerHTML=(0)+"% Complete";document.getElementById("devicesTable").innerHTML="";discoveryIndex=0;document.getElementById("scanCtrl").innerHTML="<button type='button' class='btn btn-default' onclick='startDiscovery()'> Start </button><button type='button' class='btn btn-danger' onclick='stopDiscovery()'> Stop </button>";discoveryContinue=true;nextDiscover()}function stopDiscovery(){discoveryContinue=false;var a=document.getElementById("scanCtrl");a.innerHTML="<button type='button' class='btn btn-success' onclick='startDiscovery()'> Start </button>";a.innerHTML+="<button type='button' class='btn btn-default' onclick='stopDiscovery()'> Stop </button>"}function ping(b,d){if(!this.inUse){this.status="unchecked";this.inUse=true;this.callback=d;this.ip=b;var a=this;this.xhr=createCORSRequest("GET","http://"+b+"/config");this.xhr.timeout=400;this.xhr.onload=function(){a.inUse=false;a.callback(a.ip,"success")};this.xhr.onerror=function(f){if(a.inUse){a.inUse=false;a.callback(a.ip,"error",f)}};this.xhr.ontimeout=function(){if(a.inUse){a.inUse=false;a.callback(a.ip,"timeout","timeout")}};this.xhr.onabort=function(){if(a.inUse){a.inUse=false;a.callback(a.ip,"abort","computer")}};this.xhr.send()}}function raw2celsius(a){rb=10000;res=1023;beta=3950;ginf=120.6685;kelvin=273.15+4;rth=rb*(res/(a/8)-1);temp=beta/Math.log(rth*ginf);return(temp-kelvin).toFixed(1)}function raw2percent(a){min=10;max=895;a=a/8;if(a<min){return 0}else{if(a>max){return 100}}return(100*(a-min)/(max-min)).toFixed(1)}function raw2light(a){min=170;max=761;a=a/8;if(a<min){return 0}else{if(a>max){return 100}}return(100*(a-min)/(max-min)).toFixed(1)}function showPorts(b){if(b!="object"){values=JSON.parse(b)}else{values=b}var a="",d="";document.getElementById("devName2").innerHTML=values.deviceName.replace("_"," ").replace("%20"," ");for(i=0;i<6;i++){port="A"+i;type=values.inputs[i].type;value=values.inputs[i].val;switch(type){case"t":value=raw2celsius(value)+" ºC";break;case"p":value=raw2percent(value)+" %";break;case"l":value=raw2light(value)+" % of light";break;case"r":value=(value/8).toFixed(1);break;case"b":if(value/8>512){value="On"}else{value="Off"}break;default:value="Void";break}a+="<tr><td style='text-align:center;'>"+port+"</td><td style='text-align:center;'>"+value+"</td>";if(modalsEnabled()){a+="<td>"+generateModalButton(i,type)+"</td>";d+=generateModalWindow(i)}a+="</tr>"}document.getElementById("analogReads").innerHTML=a;document.getElementById("modals").innerHTML=d;a="";for(i=0;i<6;i++){port="O"+i;value=values.outputs[i].val;if(value=="On"){a+="<tr><td style='text-align:center;'>"+port+"</td><td style='text-align:center;'>"+value+"</td><td><div class='btn-group btn-group-sm'><button class='lbl btn-success' onclick='setOutput(\""+i+"1\")'>On</button><button class='lbl btn-danger btn-xs' onclick='setOutput(\""+i+"0\")'>Off</button></div></td></tr>"}else{if(value=="Off"){a+="<tr><td style='text-align:center;'>"+port+"</td><td style='text-align:center;'>"+value+"</td><td><div class='btn-group btn-group-sm'><button class='lbl btn-success' onclick='setOutput(\""+i+"1\")'>On</button><button class='lbl btn-danger btn-xs' onclick='setOutput(\""+i+"0\")'>Off</button></div></td></tr>"}else{a+="<tr><td style='text-align:center;'>"+port+"</td><td style='text-align:center;'>"+value+"</td><td></td></tr>"}}}document.getElementById("actuators").innerHTML=a}function showConfig(a){var b;if(typeof(a)!="object"){config=JSON.parse(a)}else{config=a}document.getElementById("devName").innerHTML=config.deviceName.replace("_"," ").replace("%20"," ");document.getElementById("newName").placeholder=config.deviceName.replace("_"," ").replace("%20"," ");b=document.getElementById("setNewIp");switch(config.ip){case"1":b.innerHTML="192.168.10.130:8080/26 <span class='caret'></span>";if(b.value==""){b.value="192.168.10.130"}break;case"2":b.innerHTML="10.0.1.2:80/24 <span class='caret'></span>";if(b.value==""){b.value="10.0.1.2"}break;case"3":b.innerHTML="10.0.1.130:8080/26 <span class='caret'></span>";if(b.value==""){b.value="10.0.1.130"}break;default:b.innerHTML="192.168.10.2:80/24 <span class='caret'></span>";if(b.value==""){b.value="192.168.10.2"}break}b=document.getElementById("setPayloadSize");switch(config.packetSize){case"0":b.innerHTML="512 Bytes <span class='caret'></span>";break;case"1":b.innerHTML="768 Bytes <span class='caret'></span>";break;case"2":b.innerHTML="1024 Bytes <span class='caret'></span>";break;default:b.innerHTML="1280 Bytes <span class='caret'></span>";break}b=document.getElementById("setNewSamplingTime");switch(config.samplingTime){case"0":b.innerHTML="1 second <span class='caret'></span>";break;case"1":b.innerHTML="5 seconds <span class='caret'></span>";break;case"2":b.innerHTML="10 seconds <span class='caret'></span>";break;case"3":b.innerHTML="1 minute <span class='caret'></span>";break;case"4":b.innerHTML="5 minutes <span class='caret'></span>";break;case"5":b.innerHTML="10 minutes <span class='caret'></span>";break;default:b.innerHTML="1 second <span class='caret'></span>";break}for(i=0;i<6;i++){type=config.ports[i].type;configDevice("an"+i,type)}for(i=6;i<12;i++){type=config.ports[i].type;configDevice("out"+(i-6),type)}if(document.domain!=document.getElementById("setNewIp").value||document.domain!=document.getElementById("ipAddress").value){document.getElementById("cofDevTabBtn").style.display="none"}else{document.getElementById("cofDevTabBtn").style.display="block"}}arduinoIp=document.domain;if(arduinoIp!=""){document.getElementById("ipAddress").value=arduinoIp;document.getElementById("ipAddress2").value=arduinoIp;intIP=convertIPv4FromString(arduinoIp);intIP[3]=1;document.getElementById("startIP").value=convertIPv4FromIntArray(intIP);intIP[3]=255;document.getElementById("endIP").value=convertIPv4FromIntArray(intIP);configDev("config")}else{document.getElementById("ipAddress").value="192.168.10.2";document.getElementById("ipAddress2").value="192.168.10.2";document.getElementById("startIP").value="192.168.10.1";document.getElementById("endIP").value="192.168.10.10";configDev("config")}function modalsEnabled(){if(typeof d3!=="undefined"&&$(window).width()>800){return true}return false}function generateModalButton(a,b){return"    <a class='btn btn-mini' data-toggle='modal' onclick='plotGraph("+a+', "'+b+"\")' href='#modal"+a+"' class='btn btn-primary btn-large'>Graph</a>"}function generateModalWindow(a){var b="";b+=("<div class='modal hide fade' id='modal"+a+"' tabindex='-1' role='dialog' aria-labelledby='modal"+a+"Label' aria-hidden='true'>");b+=("<div class='modal-header'>");b+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>";b+="<h4 class='modal-title' id='modal"+a+"Label'>TITLE</h4>";b+=("</div>");b+=("<div id='modal-body"+a+"' class='modal-body'>");b+=("<div id='loadinggif"+i+"' style='text-align:center;'><img src='https://github.com/xarteaga/RESTduino/blob/864de606cb76de2b70070e79729b9716ef1cb570/UserGUI/img/loading.gif?raw=true'/></div>");b+=("<div id='graph"+i+"' style='width:530px; height:0px;'></div>");b+=("</div>");b+=("<div class='modal-footer'>");b+=("<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>");b+=("</div>");b+=("</div>");b+=("</div>");return b}function plotGraph(l,e){stopAutoRead();res=document.getElementById("ipAddress2").value.split(":");if(res.length!=2){res[1]=80}if(document.domain!=res[0]){url="http://"+res[0]+":"+res[1]+"/hist"+l}else{url="/hist"+l}var s,a,r,m;switch(e){case"t":s="Temperature [ºC]";r=50;minimum=10;m=raw2celsius;break;case"l":s="Light percent [%]";r=100;minimum=0;m=raw2light;break;case"p":s="Potentiometer percent [%]";r=100;minimum=0;m=raw2percent;break;default:s="Raw data [10 bit scale]";r=1023;minimum=0;m=function(v){return v/8};break}var f=$(window).height()*0.5;var d=document.getElementById("graph"+l).innerHTML="";document.getElementById("loadinggif"+l).innerHTML="<img src='https://github.com/xarteaga/RESTduino/blob/864de606cb76de2b70070e79729b9716ef1cb570/UserGUI/img/loading.gif?raw=true'/>";document.getElementById("modal"+l+"Label").innerHTML="Analog input "+l;document.getElementById("modal"+l).style.cssText="width:"+$(window).width()*0.9+"px;margin-left:"+(-$(window).width()*0.9/2)+"px;";document.getElementById("modal-body"+l).style.maxHeight=f+"px";document.getElementById("graph"+l).style.height=f+"px";var n={top:20,right:20,bottom:30,left:50},q=$(window).width()*0.9-50-n.left-n.right,p=f-n.top-n.bottom;var u=d3.time.format("%a, %d %b %Y %H:%M:%S GMT").parse;var j=d3.time.scale().range([0,q]);var h=d3.scale.linear().range([p,0]);var g=d3.svg.axis().scale(j).orient("bottom");var b=d3.svg.axis().scale(h).orient("left");var k=d3.svg.line().x(function(v){return j(v.date)}).y(function(v){return h(v.value)});var o=d3.select("#graph"+l).append("svg").attr("width",q+n.left+n.right).attr("height",p+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");d3.json(url,function(w){document.getElementById("loadinggif"+l).innerHTML="";w.splice(0,1);for(var v=0;v<w.length;v++){if(w[v].date=="nan"){w.splice(v,1);v--}else{w[v].date=u(w[v].date);w[v].value=m(+w[v].value)}}j.domain(d3.extent(w,function(x){return x.date}));h.domain([minimum,r]);o.append("g").attr("class","x axis").attr("transform","translate(0,"+p+")").call(g);o.append("g").attr("class","y axis").call(b).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(s);o.append("path").datum(w).attr("class","line").attr("d",k)})};