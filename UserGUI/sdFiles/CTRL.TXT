function configDevice(d,a){var b=document.getElementById(d);switch(a){case"e":c="btn-default";t="Void";break;case"r":c="btn-info";t="Raw";break;case"w":c="btn-success";t="PWM";break;case"p":c="btn-success";t="Potentiometer";break;case"l":c="btn-warning";t="Light";break;case"t":c="btn-danger";t="Temperature";break;case"b":c="btn-primary";t="Logical";break;default:c="btn-default";t="Error";break}b.setAttribute("class","btn "+c+" dropdown-toggle");b.setAttribute("Value",t);b.innerHTML=t+' <span class="caret"></span>'}function countAddr(a,b){return a[3]-b[3]+1+(a[2]-b[2])*256+(a[1]-b[1])*256*256+(a[0]-b[0])*256*256*256}function convertIPv4FromString(a){res=a.split(".");if(res.length!=4){window.alert("Bad format in one IP Address");return null}ipOut=[];res.forEach(function(b){intNum=parseInt(b);if(intNum>255||intNum<0){window.alert("The IP address number must be below 255! (Address: $ipIn)");return null}ipOut.push(intNum)});return ipOut}function convertIPv4FromIntArray(a){return a[0]+"."+a[1]+"."+a[2]+"."+a[3]}function addOneIPv4(b){var a=convertIPv4FromString(b);a[3]++;if(a[3]==256){a[3]=0;a[2]++;if(a[2]==256){a[2]=0;a[2]++;if(a[1]==256){a[1]=0;a[0]++}}}return convertIPv4FromIntArray(a)}function validateIPv4(b){var a=b.split(".");if(a.length!=4){return false}a.forEach(function(d){d=parseInt(d);if(d>256||d<0){return false}});return true}function createCORSRequest(d,a){var b=new XMLHttpRequest();if("withCredentials" in b){b.open(d,a,true)}else{if(typeof XDomainRequest!="undefined"){b=new XDomainRequest();b.open(d,a)}else{b=null}}b.timeout=1000;b.onerror=function(f){stopAutoRead();window.alert("The IP address does not point to a valid Server\nURL:'"+a+"'\n"+f)};b.ontimeout=function(){stopAutoRead();window.alert("The IP address is unreachable.\nURL:'"+a+"'")};return b}function configDevProtected(a){if(document.domain!=document.getElementById("setNewIp").value){window.alert("This functionality is only available for computers inside server network! (Address: '"+document.getElementById("setNewIp").value+"')");return}$.get(a).done(function(b){showConfig(b)})}function configDev(b){res=document.getElementById("ipAddress").value.split(":");port=80;if(!validateIPv4(res[0])){window.alert("IP Address not valid!");return}if(res.length==2){port=res[1]}if(document.domain!=res[0]){url="http://"+res[0]+":"+port+"/"+b}else{url="/"+b}var a=createCORSRequest("GET",url);if(!a){window.alert("CORS not supported");return}a.onload=function(){showConfig(a.responseText)};a.send()}var timer=null;var failedReads=0;function startAutoRead(){var a=document.getElementById("refreshTime").value;if(!parseInt(a)>0){window.alert("The refresh time must be numeric!");return}if(timer!=null){stopAutoRead()}failedReads=0;document.getElementById("startStopButtons").innerHTML="<button type='button' class='btn btn-default'>Start</button><button type='button' class='btn btn-danger' onclick='stopAutoRead()'>Stop</button>";timer=setInterval(function(){readValues()},a*1000);readValues()}function stopAutoRead(){clearInterval(timer);timer=null;document.getElementById("startStopButtons").innerHTML="<button type='button' class='btn btn-success' onclick='startAutoRead()'>Start</button><button type='button' class='btn btn-default'>Stop</button>"}function errorReading(){failedReads+=1;if(failedReads==3){failedReads=0;stopAutoRead();window.alert("Three failed trials to read sensors. Did you write properly the ip address?")}}function readValues(){res=document.getElementById("ipAddress2").value.split(":");if(res.length!=2){res[1]=80}if(document.domain!=res[0]){url="http://"+res[0]+":"+res[1]+"/ports"}else{url="/ports"}if(!validateIPv4(res[0])){stopAutoRead();window.alert("IP Address not valid!");return}var a=createCORSRequest("GET",url);if(!a){stopAutoRead();window.alert("CORS not supported");return}a.onload=function(){showPorts(a.responseText)};a.timeout=2000;a.onError=function(b){errorReading()};a.onTimeout=function(){errorReading()};a.send()}function setOutput(a){res=document.getElementById("ipAddress2").value.split(":");if(res.length!=2){res[1]=80}if(document.domain!=res[0]){url="http://"+res[0]+":"+res[1]+"/out/"+a}else{url="/out/"+a}var b=createCORSRequest("GET",url);b.onload=function(){showPorts(b.responseText)};b.send()}discoveryContinue=0;discoveryCount=0;discoveryIndex=0;discoveryIpCurrent=0;function nextDiscover(){new ping(discoveryIpCurrent,function(f,a,d){var b=document.getElementById("progressbar");percent=parseFloat(b.getAttribute("percent"))+1/(discoveryCount)*100;b.setAttribute("percent",percent);b.setAttribute("style","width: "+percent+"%");document.getElementById("progresslbl").innerHTML=Math.round(percent)+"% Complete";label="undefined";if(a=="success"){label='<span class="label label-success">Online Arduino</span>'}else{if(a=="error"){label='<span class="label label-warning">Other host</span>'}else{if(a=="aborted"&&document.getElementById("showOffline").checked==true){label='<span class="label label-default">Offline</span>'}else{if(document.getElementById("showOffline").checked==true){label='<span class="label label-default">Offline</span>'}}}}if(label!="undefined"){document.getElementById("devicesTable").innerHTML+="<tr><td>"+f+"</td><td><center>"+label+"</center></td></tr>"}});discoveryIpCurrent=addOneIPv4(discoveryIpCurrent);discoveryIndex=discoveryIndex+1;if(discoveryIndex<discoveryCount&&discoveryContinue==true){discoveryTimer=setTimeout(function(){nextDiscover()},200)}else{stopDiscovery()}}function startDiscovery(){discoveryIpCurrent=document.getElementById("startIP").value;startAddrInt=convertIPv4FromString(discoveryIpCurrent);stopAddrInt=convertIPv4FromString(document.getElementById("endIP").value);if(startAddrInt==null||stopAddrInt==null){return}discoveryCount=countAddr(stopAddrInt,startAddrInt);if(discoveryCount<0){window.alert("The start address must be lower than end address (count: "+discoveryCount+")");return}console.log("Starting scan... Number of ip addresses: "+discoveryCount);var a=document.getElementById("progressbar");a.setAttribute("percent",0);a.setAttribute("style","width: "+0+"%");document.getElementById("progresslbl").innerHTML=(0)+"% Complete";document.getElementById("devicesTable").innerHTML="";discoveryIndex=0;document.getElementById("scanCtrl").innerHTML="<button type='button' class='btn btn-default' onclick='startDiscovery()'> Start </button><button type='button' class='btn btn-danger' onclick='stopDiscovery()'> Stop </button>";discoveryContinue=true;nextDiscover()}function stopDiscovery(){discoveryContinue=false;var a=document.getElementById("scanCtrl");a.innerHTML="<button type='button' class='btn btn-success' onclick='startDiscovery()'> Start </button>";a.innerHTML+="<button type='button' class='btn btn-default' onclick='stopDiscovery()'> Stop </button>"}function ping(b,d){if(!this.inUse){this.status="unchecked";this.inUse=true;this.callback=d;this.ip=b;var a=this;this.xhr=createCORSRequest("GET","http://"+b+"/config");this.xhr.timeout=400;this.xhr.onload=function(){a.inUse=false;a.callback(a.ip,"success")};this.xhr.onerror=function(f){if(a.inUse){a.inUse=false;a.callback(a.ip,"error",f)}};this.xhr.ontimeout=function(){if(a.inUse){a.inUse=false;a.callback(a.ip,"timeout","timeout")}};this.xhr.onabort=function(){if(a.inUse){a.inUse=false;a.callback(a.ip,"abort","computer")}};this.xhr.send()}}function showPorts(a){if(a!="object"){values=JSON.parse(a)}else{values=a}table=document.getElementById("analogReads");document.getElementById("devName2").innerHTML=values.deviceName.replace("_"," ").replace("%20"," ");table.innerHTML="";for(i=0;i<6;i++){port="A"+i;value=values.inputs[i].val;table.innerHTML+="<tr><td><center>"+port+"</center></td><td><center>"+value+"</center></td></tr>"}table=document.getElementById("actuators");table.innerHTML="";for(i=0;i<6;i++){port="O"+i;value=values.outputs[i].val;if(value=="On"){table.innerHTML+="<tr><td><center>"+port+"</center></td><td><center>"+value+"</center></td><td><div class='btn-group btn-group-sm'><button class='lbl btn-success' onclick='setOutput(\""+i+"1\")'>On</button><button class='lbl btn-danger btn-xs' onclick='setOutput(\""+i+"0\")'>Off</button></div></td></tr>"}else{if(value=="Off"){table.innerHTML+="<tr><td><center>"+port+"</center></td><td><center>"+value+"</center></td><td><div class='btn-group btn-group-sm'><button class='lbl btn-success' onclick='setOutput(\""+i+"1\")'>On</button><button class='lbl btn-danger btn-xs' onclick='setOutput(\""+i+"0\")'>Off</button></div></td></tr>"}else{table.innerHTML+="<tr><td><center>"+port+"</center></td><td><center>"+value+"</center></td><td></td></tr>"}}}}function showConfig(a){if(typeof(a)!="object"){config=JSON.parse(a)}else{config=a}document.getElementById("devName").innerHTML=config.deviceName.replace("_"," ").replace("%20"," ");switch(config.ip){case"1":document.getElementById("setNewIp").innerHTML="192.168.10.130:8080/26 <span class='caret'></span>";if(document.getElementById("setNewIp").value==""){document.getElementById("setNewIp").value="192.168.10.130"}break;case"2":document.getElementById("setNewIp").innerHTML="10.0.1.2:80/24 <span class='caret'></span>";if(document.getElementById("setNewIp").value==""){document.getElementById("setNewIp").value="10.0.1.2"}break;case"3":document.getElementById("setNewIp").innerHTML="10.0.1.130:8080/26 <span class='caret'></span>";if(document.getElementById("setNewIp").value==""){document.getElementById("setNewIp").value="10.0.1.130"}break;default:document.getElementById("setNewIp").innerHTML="192.168.10.2:80/24 <span class='caret'></span>";if(document.getElementById("setNewIp").value==""){document.getElementById("setNewIp").value="192.168.10.2"}break}for(i=0;i<6;i++){type=config.ports[i].type;configDevice("an"+i,type)}for(i=6;i<12;i++){type=config.ports[i].type;configDevice("out"+(i-6),type)}}arduinoIp=document.domain;if(arduinoIp!=""){document.getElementById("ipAddress").value=arduinoIp;document.getElementById("ipAddress2").value=arduinoIp;intIP=convertIPv4FromString(arduinoIp);intIP[3]=1;document.getElementById("startIP").value=convertIPv4FromIntArray(intIP);intIP[3]=255;document.getElementById("endIP").value=convertIPv4FromIntArray(intIP);configDev("config")}else{document.getElementById("ipAddress").value="192.168.10.2";document.getElementById("ipAddress2").value="192.168.10.2";document.getElementById("startIP").value="192.168.10.1";document.getElementById("endIP").value="192.168.10.10";configDev("config")};